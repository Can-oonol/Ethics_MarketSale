<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sustainable Fashion Cart – Student View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      background: #ffffff;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    header p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #555;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #111827;
      font-size: 0.75rem;
      margin-top: 8px;
      font-weight: 600;
    }

    .section-title {
      font-size: 1.1rem;
      margin: 0 0 8px;
      font-weight: 600;
    }

    #products {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .product-card {
      border-radius: 12px;
      border: 1px solid #e2e2e2;
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .product-info {
      flex: 1;
    }

    .product-name {
      font-weight: 600;
      margin: 0 0 4px;
      font-size: 0.95rem;
    }

    .product-price {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .impact-tag {
      display: inline-block;
      margin-top: 2px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #f3f4f6;
      color: #4b5563;
    }

    .product-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-primary {
      background: #111827;
      color: #ffffff;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    #cart {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 12px;
      background: #f9fafb;
    }

    #cart-items {
      list-style: none;
      padding: 0;
      margin: 0 0 8px;
      max-height: 160px;
      overflow-y: auto;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      padding: 4px 0;
    }

    .cart-item-name {
      flex: 1;
      margin-right: 4px;
    }

    .cart-item-qty {
      margin: 0 6px;
      font-weight: 600;
    }

    .cart-item-controls button {
      padding: 2px 7px;
      font-size: 0.75rem;
      border-radius: 999px;
    }

    .cart-empty {
      font-size: 0.85rem;
      color: #777;
    }

    #summary {
      border-top: 1px dashed #d1d5db;
      padding-top: 8px;
      font-size: 0.85rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin: 2px 0;
    }

    .summary-label {
      color: #555;
    }

    .summary-value {
      font-weight: 600;
    }

    #checkout {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #message {
      font-size: 0.8rem;
      color: #16a34a;
      min-height: 1.2em;
    }

    .footnote {
      font-size: 0.7rem;
      color: #888;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Fashion Cart</h1>
      <p>Select items and simulate a purchase. (Impact will be revealed later in the discussion.)</p>
      <div class="badge">Demo only · no real payments</div>
    </header>

    <section>
      <h2 class="section-title">Choose your items</h2>
      <div id="products"></div>
    </section>

    <section id="cart">
      <h2 class="section-title">Your cart</h2>
      <ul id="cart-items"></ul>
      <div id="summary"></div>

      <div id="checkout">
        <button id="checkout-btn" class="btn-primary" disabled>Simulate payment</button>
        <div id="message"></div>
        <p class="footnote">
          This is a case-study demo. No real money is used.
        </p>
      </div>
    </section>
  </div>

  <script>
    // === CONFIG: backend URL for saving purchases ===
    const API_BASE = "http://145.94.191.229:4000";

    // --- Data model: clothing items with price and environmental impact (hidden from user) ---
    const products = [
      {
        id: "tshirt_cotton",
        name: "Basic Cotton T-Shirt",
        price: 19.99,
        co2: 4.0,       // kg CO2e (used only for admin/stats)
        water: 2700,    // liters
        note: "Standard cotton t-shirt"
      },
      {
        id: "jeans",
        name: "Blue Denim Jeans",
        price: 59.99,
        co2: 20.0,
        water: 7600,
        note: "Regular denim jeans"
      },
      {
        id: "hoodie",
        name: "Fleece Hoodie",
        price: 49.99,
        co2: 14.0,
        water: 4000,
        note: "Warm fleece hoodie"
      },
      {
        id: "organic_tshirt",
        name: "Organic Cotton T-Shirt",
        price: 29.99,
        co2: 3.0,
        water: 1800,
        note: "Organic cotton t-shirt"
      },
      {
        id: "recycled_jacket",
        name: "Recycled Fabric Jacket",
        price: 89.99,
        co2: 12.0,
        water: 2500,
        note: "Jacket with recycled fibers"
      }
    ];

    // Cart as { productId: quantity }
    const cart = {};

    const productsContainer = document.getElementById("products");
    const cartItemsEl = document.getElementById("cart-items");
    const summaryEl = document.getElementById("summary");
    const checkoutBtn = document.getElementById("checkout-btn");
    const messageEl = document.getElementById("message");

    function formatMoney(value) {
      return "€" + value.toFixed(2);
    }

    function renderProducts() {
      productsContainer.innerHTML = "";
      products.forEach((p) => {
        const card = document.createElement("div");
        card.className = "product-card";

        const info = document.createElement("div");
        info.className = "product-info";

        const nameEl = document.createElement("p");
        nameEl.className = "product-name";
        nameEl.textContent = p.name;

        const priceEl = document.createElement("p");
        priceEl.className = "product-price";
        priceEl.textContent = formatMoney(p.price);

        const noteEl = document.createElement("span");
        noteEl.className = "impact-tag";
        noteEl.textContent = p.note;

        info.appendChild(nameEl);
        info.appendChild(priceEl);
        info.appendChild(noteEl);

        const actions = document.createElement("div");
        actions.className = "product-actions";

        const addBtn = document.createElement("button");
        addBtn.className = "btn-primary";
        addBtn.textContent = "Add to cart";
        addBtn.onclick = () => {
          addToCart(p.id);
        };

        actions.appendChild(addBtn);

        card.appendChild(info);
        card.appendChild(actions);

        productsContainer.appendChild(card);
      });
    }

    function addToCart(productId) {
      cart[productId] = (cart[productId] || 0) + 1;
      renderCart();
    }

    function updateQuantity(productId, delta) {
      if (!cart[productId]) return;
      cart[productId] += delta;
      if (cart[productId] <= 0) {
        delete cart[productId];
      }
      renderCart();
    }

    function renderCart() {
      cartItemsEl.innerHTML = "";
      summaryEl.innerHTML = "";
      messageEl.textContent = "";

      const ids = Object.keys(cart);
      if (ids.length === 0) {
        const empty = document.createElement("p");
        empty.className = "cart-empty";
        empty.textContent = "Your cart is empty. Add some items to start.";
        cartItemsEl.appendChild(empty);
        checkoutBtn.disabled = true;
        return;
      }

      let totalPrice = 0;
      let totalCo2 = 0;
      let totalWater = 0;

      const itemsPayload = [];

      ids.forEach((id) => {
        const qty = cart[id];
        const product = products.find((p) => p.id === id);
        if (!product) return;

        totalPrice += product.price * qty;
        totalCo2 += product.co2 * qty;
        totalWater += product.water * qty;

        itemsPayload.push({
          id: product.id,
          name: product.name,
          qty: qty,
          linePrice: product.price * qty,
          lineCo2: product.co2 * qty,
          lineWater: product.water * qty
        });

        const li = document.createElement("li");
        li.className = "cart-item";

        const nameSpan = document.createElement("span");
        nameSpan.className = "cart-item-name";
        nameSpan.textContent = product.name;

        const controls = document.createElement("div");
        controls.className = "cart-item-controls";

        const minusBtn = document.createElement("button");
        minusBtn.className = "btn-secondary";
        minusBtn.textContent = "−";
        minusBtn.onclick = () => updateQuantity(id, -1);

        const qtySpan = document.createElement("span");
        qtySpan.className = "cart-item-qty";
        qtySpan.textContent = qty;

        const plusBtn = document.createElement("button");
        plusBtn.className = "btn-secondary";
        plusBtn.textContent = "+";
        plusBtn.onclick = () => updateQuantity(id, +1);

        const lineTotal = document.createElement("span");
        lineTotal.textContent = formatMoney(product.price * qty);

        controls.appendChild(minusBtn);
        controls.appendChild(qtySpan);
        controls.appendChild(plusBtn);

        li.appendChild(nameSpan);
        li.appendChild(controls);
        li.appendChild(lineTotal);

        cartItemsEl.appendChild(li);
      });

      // Summary section: ONLY price is shown to the user
      const row = document.createElement("div");
      row.className = "summary-row";

      const label = document.createElement("span");
      label.className = "summary-label";
      label.textContent = "Items total";

      const val = document.createElement("span");
      val.className = "summary-value";
      val.textContent = formatMoney(totalPrice);

      row.appendChild(label);
      row.appendChild(val);
      summaryEl.appendChild(row);

      checkoutBtn.disabled = false;

      // Attach click handler with current totals + item details
      checkoutBtn.onclick = function () {
        simulatePayment(totalPrice, totalCo2, totalWater, itemsPayload);
      };
    }

    async function simulatePayment(totalPrice, totalCo2, totalWater, itemsPayload) {
      // Message shown to student: only about money / confirmation
      const text =
        "Payment simulated: you “spent” " + formatMoney(totalPrice) +
        ". Your choices will be discussed afterwards.";
      messageEl.textContent = text;

      // Payload still includes all environmental data for the admin
      const payload = {
        items: itemsPayload,
        totalPrice: totalPrice,
        totalCo2: totalCo2,
        totalWater: totalWater
      };

      try {
        await fetch(API_BASE + "/api/purchases", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error("Failed to send purchase", err);
        messageEl.textContent += " (But sending data to admin failed.)";
      }
    }

    // Initialize
    renderProducts();
    renderCart();
  </script>
</body>
</html>
